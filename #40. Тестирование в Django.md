---


---

<h1 id="тестирование-в-django">Тестирование в Django</h1>
<p><img src="https://files.realpython.com/media/Django-Tutorials_Watermarked.2ecff49f3456.jpg" alt="enter image description here"></p>
<h2 id="план">План</h2>
<ol>
<li>Тестирование в Django
<ol>
<li>Особенности тестирования</li>
<li>Client</li>
</ol>
</li>
<li>Tестирование в DRF
<ol>
<li>APITestCase</li>
<li>APIClient</li>
</ol>
</li>
<li>Фабричный метод и фабрики
<ol>
<li>RequestFactory</li>
<li>Factory Boy, Fuzzy attributes</li>
<li>Faker</li>
</ol>
</li>
<li>Литература</li>
</ol>
<h2 id="тестирование-в-django-1">Тестирование в Django</h2>
<p>Если вы пишете тесты для веб-приложений, то стоит помнить о важных отличиях в написании и запуске таких тестов.</p>
<p>Подумайте о коде, который нужно протестировать в веб-приложении. Все маршруты, представления и модели требуют много импортов и знаний об используемом фреймворке.<br>
Это похоже на тестирование автомобиля: перед тем, как провести простые тесты, вроде проверки работы фар, нужно включить компьютер в машине.</p>
<p>Django упрощают эту задачу и предоставляют тестовый фреймворк на базе unittest. Вы можете продолжать писать тесты привычным образом, но исполнять их чуть иначе.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>test <span class="token keyword">import</span> TestCase

<span class="token keyword">class</span> <span class="token class-name">MyTestCase</span><span class="token punctuation">(</span>TestCase<span class="token punctuation">)</span>
<span class="token punctuation">:</span>   
    <span class="token keyword">def</span> <span class="token function">setUp</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Установки запускаются перед каждым тестом</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">tearDown</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Очистка после каждого метода</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">test_something_that_will_pass</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>assertFalse<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">test_something_that_will_fail</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>assertTrue<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre>
<p>Основное отличие от прошлых примеров — нужно наследовать из <code>django.test.TestCase</code>, а не <code>unittest.TestCase</code>.</p>
<pre class=" language-python"><code class="prism  language-python">TestCase<span class="token punctuation">.</span>mro<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'django.test.testcases.TestCase'</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
 <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'django.test.testcases.TransactionTestCase'</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
 <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'django.test.testcases.SimpleTestCase'</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
 <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'unittest.case.TestCase'</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
 <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'object'</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://docs.djangoproject.com/en/2.2/_images/django_unittest_classes_hierarchy.svg" alt="enter image description here"><br>
Для исполнения тестового набора используйте <code>manage.py</code> test вместо unittest в командной строке:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token punctuation">.</span><span class="token operator">/</span>manage<span class="token punctuation">.</span>py test
</code></pre>
<p>Если вам нужно несколько тестовых файлов, замените <a href="http://tests.py">tests.py</a> на папку tests, положите в нее пустой файл с названием <code>__init__.py</code> и создайте файлы <code>test_*.py</code>. Django обнаружит их и выполнит.</p>
<h3 id="новые-assertions">Новые Assertions</h3>
<p><code>assertContains</code>(<em>response</em>, <em>text</em>)<br>
<code>assertNotContains</code>(<em>response</em>, <em>text</em>)<br>
<code>assertTemplateUsed</code>(<em>response</em>, <em>template_name</em>)<br>
<code>assertTemplateNotUsed</code>(<em>response</em>, <em>template_name</em>)<br>
<code>assertURLEqual</code>(<em>url1</em>, <em>url2</em>)<br>
<code>assertRedirects</code>(<em>response</em>, <em>expected_url</em>, <em>status_code=302</em>, <em>target_status_code=200</em>)<br>
<code>assertHTMLEqual</code>(<em>html1</em>, <em>html2</em>)<br>
<code>assertHTMLNotEqual</code>(<em>html1</em>, <em>html2</em>)<br>
<code>assertXMLEqual</code>(<em>xml1</em>, <em>xml2</em>)<br>
<code>assertXMLNotEqual</code>(<em>xml1</em>, <em>xml2</em>)<br>
<code>assertJSONEqual</code>(<em>raw</em>, <em>expected_data</em>)<br>
<code>assertJSONNotEqual</code>(<em>raw</em>, <em>expected_data</em>)</p>
<p>Остальные в <a href="https://docs.djangoproject.com/en/2.2/topics/testing/tools/#assertions">документации</a></p>
<p><strong>База данных для тестирования</strong></p>
<p>Для тестов используется отдельная база данных, которая будет указана в переменной  <code>TEST</code>  в переменной  <code>DATABASES</code>  в файле  <code>settings.py</code>:</p>
<pre class=" language-python"><code class="prism  language-python">DATABASES <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">'ENGINE'</span><span class="token punctuation">:</span> <span class="token string">'django.db.backends.postgresql'</span><span class="token punctuation">,</span>
        <span class="token string">'USER'</span><span class="token punctuation">:</span> <span class="token string">'mydatabaseuser'</span><span class="token punctuation">,</span>
        <span class="token string">'NAME'</span><span class="token punctuation">:</span> <span class="token string">'mydatabase'</span><span class="token punctuation">,</span>
        <span class="token string">'TEST'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'NAME'</span><span class="token punctuation">:</span> <span class="token string">'mytestdatabase'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Эта база будет изначально пустая, и будет очищаться после каждого выполненного тест кейса. Что-бы не очишать базу, можно указать параметр <code>--keepdb</code> (или <code>-k</code>)</p>
<h3 id="настрока-в-pycharm">Настрока в PyCharm</h3>
<p><img src="https://i.imgur.com/nXuZnEY.png" alt="enter image description here"></p>
<p>Тестирование сайта это сложная задача, потому что она состоит их нескольких логических слоев – от HTTP-запроса и запроса к моделям, до валидации формы и их обработки, а кроме того, рендеринга шаблонов страниц.</p>
<p>Django предоставляет фреймворк для создания тестов, построенного на основе иерархии классов, которые, в свою очередь, зависят от стандартной библиотеки Python <code>unittest</code>. Несмотря на название, данный фреймворк подходит и для юнит-, и для интеграционного тестирования. Фреймворк Django добавляет методы и инструменты, которые помогают тестировать как веб так и, специфическое для Django, поведение. Это позволяет вам имитировать URL-запросы, добавление тестовых данных, а также проводить проверку выходных данных ваших приложений.</p>
<p>django.test.TestCase  класс создает чистую базу данных перед запуском своих методов, а также запускает каждую функцию тестирования в его собственной транзакции. У данного класса также имеется тестовый Клиент, который вы можете использовать для имитации взаимодействия пользователя с кодом на уровне отображения.</p>
<h3 id="client"><a href="https://docs.djangoproject.com/en/2.2/topics/testing/tools/#making-requests">Client</a></h3>
<p>Для проведения интеграционного тестирования джанго приложенния нам необходимо отправлять запросы с клиента (браузера), функционал для этого нам предоставлен из коробки, и мы можем им воспользоваться:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> django<span class="token punctuation">.</span>test <span class="token keyword">import</span> Client
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> c <span class="token operator">=</span> Client<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> response <span class="token operator">=</span> c<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'/login/'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'username'</span><span class="token punctuation">:</span> <span class="token string">'john'</span><span class="token punctuation">,</span> <span class="token string">'password'</span><span class="token punctuation">:</span> <span class="token string">'smith'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>status_code
<span class="token number">200</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> response <span class="token operator">=</span> c<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'/customer/details/'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>content
b<span class="token string">'&lt;!DOCTYPE html...'</span>
</code></pre>
<p>Такой запрос не будет требовать CSRF токен</p>
<p>Поддерживает метод  <code>login()</code></p>
<pre class=" language-python"><code class="prism  language-python">c <span class="token operator">=</span> Client<span class="token punctuation">(</span><span class="token punctuation">)</span>
c<span class="token punctuation">.</span>login<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'fred'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'secret'</span><span class="token punctuation">)</span>
</code></pre>
<p>после чего запросы будут приходть от авторизированого пользователя<br>
и метод  <code>force_login</code>  принимающий объект юзера, а не логин и пароль.<br>
и метод  <code>logout()</code></p>
<p><strong>GET</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> c <span class="token operator">=</span> Client<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> response <span class="token operator">=</span> c<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'/customers/details/'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'fred'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>отправит GET запрос на</p>
<pre><code>/customers/details/?name=fred&amp;age=7
</code></pre>
<p><strong>POST</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> c <span class="token operator">=</span> Client<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> c<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'/login/'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'fred'</span><span class="token punctuation">,</span> <span class="token string">'passwd'</span><span class="token punctuation">:</span> <span class="token string">'secret'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>И response запишет ответ<br>
отправит POST запрос на</p>
<pre><code>/login/
</code></pre>
<h3 id="response">response</h3>
<pre class=" language-python"><code class="prism  language-python">response <span class="token operator">=</span> <span class="token punctuation">{</span>TemplateResponse<span class="token punctuation">}</span> <span class="token operator">&lt;</span>TemplateResponse status_code<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"text/html; charset=utf-8"</span><span class="token operator">&gt;</span>
 charset <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token builtin">str</span><span class="token punctuation">}</span> <span class="token string">'utf-8'</span>
 client <span class="token operator">=</span> <span class="token punctuation">{</span>Client<span class="token punctuation">}</span> <span class="token operator">&lt;</span>django<span class="token punctuation">.</span>test<span class="token punctuation">.</span>client<span class="token punctuation">.</span>Client <span class="token builtin">object</span> at <span class="token number">0x7f1b7b1ed850</span><span class="token operator">&gt;</span>
 closed <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token builtin">bool</span><span class="token punctuation">}</span> <span class="token boolean">True</span>
 content <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token builtin">bytes</span><span class="token punctuation">:</span> <span class="token number">2495</span><span class="token punctuation">}</span> b'<span class="token operator">&lt;</span>!DOCTYPE html<span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">"en"</span><span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>\n  \n  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Local Library<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>\n  <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token operator">&gt;</span>\n  <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">"viewport"</span> content<span class="token operator">=</span><span class="token string">"width=device-width, initial-scale=1"</span><span class="token operator">&gt;</span>\n  <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span>"https<span class="token punctuation">:</span><span class="token operator">//</span>cdn<span class="token punctuation">.</span>jsdelivr<span class="token punctuation">.</span>net<span class="token operator">/</span>npm<span class="token operator">/</span>bootstrap@<span class="token number">4.5</span><span class="token punctuation">.</span><span class="token number">3</span><span class="token operator">/</span>d
 context <span class="token operator">=</span> <span class="token punctuation">{</span>ContextList<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">'True'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">'False'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'None'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'csrf_token'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>SimpleLazyObject<span class="token punctuation">:</span> <span class="token operator">&lt;</span>function csrf<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token builtin">locals</span><span class="token operator">&gt;</span><span class="token punctuation">.</span>_get_val at <span class="token number">0x7f1b7a78d790</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> <span class="token string">'request'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>WSGIRequest<span class="token punctuation">:</span> GET <span class="token string">'/catalog/authors/'</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token string">'user'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>SimpleLazyObject<span class="token punctuation">:</span> <span class="token operator">&lt;</span>django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models<span class="token punctuation">.</span>AnonymousUser 
 context_data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token builtin">dict</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token string">'paginator'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>paginator<span class="token punctuation">.</span>Paginator <span class="token builtin">object</span> at <span class="token number">0x7f1b7a771dc0</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token string">'page_obj'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>Page <span class="token number">1</span> of <span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token string">'is_paginated'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">'object_list'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>QuerySet <span class="token punctuation">[</span><span class="token operator">&lt;</span>Author<span class="token punctuation">:</span> Surname <span class="token number">0</span><span class="token punctuation">,</span> Christian <span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>Author<span class="token punctuation">:</span> Surname <span class="token number">1</span><span class="token punctuation">,</span> Christian <span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>Author<span class="token punctuation">:</span> Surname <span class="token number">10</span><span class="token punctuation">,</span> Christian <span class="token number">10</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>Au
 cookies <span class="token operator">=</span> <span class="token punctuation">{</span>SimpleCookie<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span> 
 exc_info <span class="token operator">=</span> <span class="token punctuation">{</span>NoneType<span class="token punctuation">}</span> <span class="token boolean">None</span>
 is_rendered <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token builtin">bool</span><span class="token punctuation">}</span> <span class="token boolean">True</span>
 json <span class="token operator">=</span> <span class="token punctuation">{</span>partial<span class="token punctuation">}</span> functools<span class="token punctuation">.</span>partial<span class="token punctuation">(</span><span class="token operator">&lt;</span>bound method ClientMixin<span class="token punctuation">.</span>_parse_json of <span class="token operator">&lt;</span>django<span class="token punctuation">.</span>test<span class="token punctuation">.</span>client<span class="token punctuation">.</span>Client <span class="token builtin">object</span> at <span class="token number">0x7f1b7b1ed850</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>TemplateResponse status_code<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"text/html; charset=utf-8"</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
 reason_phrase <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token builtin">str</span><span class="token punctuation">}</span> <span class="token string">'OK'</span>
 rendered_content <span class="token operator">=</span> <span class="token punctuation">{</span>SafeString<span class="token punctuation">}</span> <span class="token operator">&lt;</span>!DOCTYPE html<span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">"en"</span><span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>\n  \n  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Local Library<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>\n  <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token operator">&gt;</span>\n  <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">"viewport"</span> content<span class="token operator">=</span><span class="token string">"width=device-width, initial-scale=1"</span><span class="token operator">&gt;</span>\n  <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"</span> integrity<span class="token operator">=</span><span class="token string">"sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"</span> crossorigin<span class="token operator">=</span><span class="token string">"anonymous"</span><span class="token operator">&gt;</span>\n\n  \n  <span class="token operator">&lt;</span>!<span class="token operator">-</span><span class="token operator">-</span> Add additional CSS <span class="token keyword">in</span> static <span class="token builtin">file</span> <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">&gt;</span>\n  \n  <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"/static/css/styles.78e88d8d7ee5.css"</span><span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>\n\n<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"container-fluid"</span><span class="token operator">&gt;</span>\n\n<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"row"</span><span class="token operator">&gt;</span>\n  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"col-sm-2"</span><span class="token operator">&gt;</span>\n  \n  <span class="token operator">&lt;</span>ul <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"sidebar-nav"</span><span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"/catalog/"</span><span class="token operator">&gt;</span>Home<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"/catalog/books/"</span><span class="token operator">&gt;</span>All books<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"/catalog/authors/"</span><span class="token operator">&gt;</span>All authors<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>\n  <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>\n \n  <span class="token operator">&lt;</span>ul <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"sidebar-nav"</span><span class="token operator">&gt;</span>\n   \n     <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"/accounts/login/?next=/catalog/authors/"</span><span class="token operator">&gt;</span>Login<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>   \n    \n  <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>\n  \n   \n \n\n  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>\n  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"col-sm-10 "</span><span class="token operator">&gt;</span>\n  \n\n<span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Author List<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>\n\n\n  <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>\n\n  \n    <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 rendering_attrs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token builtin">list</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">}</span> <span class="token punctuation">[</span><span class="token string">'template_name'</span><span class="token punctuation">,</span> <span class="token string">'context_data'</span><span class="token punctuation">,</span> <span class="token string">'_post_render_callbacks'</span><span class="token punctuation">,</span> <span class="token string">'_request'</span><span class="token punctuation">]</span>
 request <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token builtin">dict</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token string">'PATH_INFO'</span><span class="token punctuation">:</span> <span class="token string">'/catalog/authors/'</span><span class="token punctuation">,</span> <span class="token string">'REQUEST_METHOD'</span><span class="token punctuation">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'SERVER_PORT'</span><span class="token punctuation">:</span> <span class="token string">'80'</span><span class="token punctuation">,</span> <span class="token string">'wsgi.url_scheme'</span><span class="token punctuation">:</span> <span class="token string">'http'</span><span class="token punctuation">,</span> <span class="token string">'QUERY_STRING'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">}</span>
 resolver_match <span class="token operator">=</span> <span class="token punctuation">{</span>ResolverMatch<span class="token punctuation">}</span> ResolverMatch<span class="token punctuation">(</span>func<span class="token operator">=</span>catalog<span class="token punctuation">.</span>views<span class="token punctuation">.</span>AuthorListView<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kwargs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> url_name<span class="token operator">=</span>authors<span class="token punctuation">,</span> app_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> namespaces<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> route<span class="token operator">=</span>catalog<span class="token operator">/</span>authors<span class="token operator">/</span><span class="token punctuation">)</span>
 status_code <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token builtin">int</span><span class="token punctuation">}</span> <span class="token number">200</span>
 streaming <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token builtin">bool</span><span class="token punctuation">}</span> <span class="token boolean">False</span>
 template_name <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token builtin">list</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span> <span class="token punctuation">[</span><span class="token string">'catalog/author_list.html'</span><span class="token punctuation">]</span>
 templates <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token builtin">list</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>django<span class="token punctuation">.</span>template<span class="token punctuation">.</span>base<span class="token punctuation">.</span>Template <span class="token builtin">object</span> at <span class="token number">0x7f1b7a6dbcd0</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>django<span class="token punctuation">.</span>template<span class="token punctuation">.</span>base<span class="token punctuation">.</span>Template <span class="token builtin">object</span> at <span class="token number">0x7f1b7a7a6ee0</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>
 using <span class="token operator">=</span> <span class="token punctuation">{</span>NoneType<span class="token punctuation">}</span> <span class="token boolean">None</span>
 wsgi_request <span class="token operator">=</span> <span class="token punctuation">{</span>WSGIRequest<span class="token punctuation">}</span> <span class="token operator">&lt;</span>WSGIRequest<span class="token punctuation">:</span> GET <span class="token string">'/catalog/authors/'</span><span class="token operator">&gt;</span>
</code></pre>
<p><strong>Структура тестов</strong><br>
<img src="https://drive.google.com/uc?export=view&amp;id=1E_Tf8H2spWJbSOaaxvWOMiLk4c0bgvUT" alt="enter image description here"></p>
<h3 id="тестирование-view">Тестирование view</h3>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">AuthorListView</span><span class="token punctuation">(</span>generic<span class="token punctuation">.</span>ListView<span class="token punctuation">)</span><span class="token punctuation">:</span>
    model <span class="token operator">=</span> Author
    paginate_by <span class="token operator">=</span> <span class="token number">10</span>
</code></pre>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>test <span class="token keyword">import</span> TestCase
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> User
<span class="token keyword">from</span> catalog<span class="token punctuation">.</span>models <span class="token keyword">import</span> Author
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> reverse

<span class="token keyword">class</span> <span class="token class-name">AuthorListViewTest</span><span class="token punctuation">(</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>

	<span class="token keyword">def</span> <span class="token function">setUp</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  
	    <span class="token comment"># Create a user  </span>
	    self<span class="token punctuation">.</span>user <span class="token operator">=</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create_user<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'user_1'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'1X&lt;ISRUkw+tuK'</span><span class="token punctuation">)</span>
	    self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>force_login<span class="token punctuation">(</span>user<span class="token operator">=</span>self<span class="token punctuation">.</span>user<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>author <span class="token operator">=</span> Author<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>first_name<span class="token operator">=</span><span class="token string">'Christian'</span><span class="token punctuation">,</span>  last_name <span class="token operator">=</span> <span class="token string">'Author'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">test_index</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>get<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'authors'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
		assertContains`<span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">'Christian'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertTemplateUsed<span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">'catalog/author_list.html'</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">test_view</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>get<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'authors'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>author<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
		assertContains`<span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">'Christian'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertTemplateUsed<span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">'catalog/author_view.html'</span><span class="token punctuation">)</span>

	<span class="token keyword">def</span> <span class="token function">test_create</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  
		url <span class="token operator">=</span> reverse<span class="token punctuation">(</span><span class="token string">'author-create'</span><span class="token punctuation">)</span>
		data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'first_name'</span><span class="token punctuation">:</span> <span class="token string">'First Name'</span><span class="token punctuation">,</span> <span class="token string">'last_name'</span><span class="token punctuation">:</span> <span class="token string">'Surname'</span><span class="token punctuation">}</span>
	    response <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>data<span class="token punctuation">)</span>  
	    <span class="token comment"># Manually check redirect because we don't know what author was created  </span>
	    self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> <span class="token number">302</span><span class="token punctuation">)</span>  
	    self<span class="token punctuation">.</span>assertTrue<span class="token punctuation">(</span>response<span class="token punctuation">.</span>url<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'/catalog/author/'</span><span class="token punctuation">)</span>
</code></pre>
<p>В качестве значений кодов статуса можно использовать <a href="https://docs.python.org/3/library/http.html">HTTPStatus</a></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> http <span class="token keyword">import</span> HTTPStatus
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> HTTPStatus<span class="token punctuation">.</span>OK
<span class="token operator">&lt;</span>HTTPStatus<span class="token punctuation">.</span>OK<span class="token punctuation">:</span> <span class="token number">200</span><span class="token operator">&gt;</span>

 self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> HTTPStatus<span class="token punctuation">.</span>OK<span class="token punctuation">)</span> <span class="token comment"># 200</span>
 self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> HTTPStatus<span class="token punctuation">.</span>FOUND<span class="token punctuation">)</span> <span class="token comment"># 302</span>
 self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> HTTPStatus<span class="token punctuation">.</span>FORBIDDEN<span class="token punctuation">)</span> <span class="token comment"># 403</span>
 self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> HTTPStatus<span class="token punctuation">.</span>NOT_FOUND<span class="token punctuation">)</span> <span class="token comment"># 404</span>
</code></pre>
<h2 id="тестирование-rest-api">Тестирование REST API</h2>
<p>В DRF  для тестирования есть APITestCase, который дублирует TestCase из Django, но в качестве клиента выступает APIClient</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>test <span class="token keyword">import</span> APITestCase

APITestCase<span class="token punctuation">.</span>mro<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'rest_framework.test.APITestCase'</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> 
 <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'django.test.testcases.TestCase'</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> 
 <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'django.test.testcases.TransactionTestCase'</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> 
 <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'django.test.testcases.SimpleTestCase'</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> 
 <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'unittest.case.TestCase'</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> 
 <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'object'</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>
</code></pre>
<h3 id="apiclient"><a href="https://www.django-rest-framework.org/api-guide/testing/">APIClient</a></h3>
<p>В DRF есть свой клиент для запросов в котором уже прописаны все необходимые методы запросов (<code>get()</code>,  <code>post()</code>, итд.)</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>test <span class="token keyword">import</span> APIClient

client <span class="token operator">=</span> APIClient<span class="token punctuation">(</span><span class="token punctuation">)</span>
client<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">'/notes/'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'title'</span><span class="token punctuation">:</span> <span class="token string">'new idea'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'json'</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="авторизация-через-клиент">Авторизация через клиент</h4>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># Make all requests in the context of a logged in session.</span>
client <span class="token operator">=</span> APIClient<span class="token punctuation">(</span><span class="token punctuation">)</span>
client<span class="token punctuation">.</span>login<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'lauren'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'secret'</span><span class="token punctuation">)</span>

<span class="token comment"># Log out</span>
client<span class="token punctuation">.</span>logout<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>authtoken<span class="token punctuation">.</span>models <span class="token keyword">import</span> Token
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>test <span class="token keyword">import</span> APIClient

<span class="token comment"># Include an appropriate `Authorization:` header on all requests.</span>
token <span class="token operator">=</span> Token<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>user__username<span class="token operator">=</span><span class="token string">'lauren'</span><span class="token punctuation">)</span>
client <span class="token operator">=</span> APIClient<span class="token punctuation">(</span><span class="token punctuation">)</span>
client<span class="token punctuation">.</span>credentials<span class="token punctuation">(</span>HTTP_AUTHORIZATION<span class="token operator">=</span><span class="token string">'Token '</span> <span class="token operator">+</span> token<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
</code></pre>
<p>Так же подерживает форсированую авторизацию</p>
<pre class=" language-python"><code class="prism  language-python">user <span class="token operator">=</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'lauren'</span><span class="token punctuation">)</span>
client <span class="token operator">=</span> APIClient<span class="token punctuation">(</span><span class="token punctuation">)</span>
client<span class="token punctuation">.</span>force_authenticate<span class="token punctuation">(</span>user<span class="token operator">=</span>user<span class="token punctuation">)</span>
</code></pre>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> reverse
<span class="token keyword">from</span> rest_framework <span class="token keyword">import</span> status
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>test <span class="token keyword">import</span> APITestCase
<span class="token keyword">from</span> myproject<span class="token punctuation">.</span>apps<span class="token punctuation">.</span>core<span class="token punctuation">.</span>models <span class="token keyword">import</span> Account

<span class="token keyword">class</span> <span class="token class-name">AccountTests</span><span class="token punctuation">(</span>APITestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">setUp</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
		self<span class="token punctuation">.</span>user <span class="token operator">=</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create_user<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'user_1'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'1X&lt;ISRUkw+tuK'</span><span class="token punctuation">)</span>
		<span class="token comment">#self.client = APIClient()</span>
		self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>force_authenticate<span class="token punctuation">(</span>user<span class="token operator">=</span>self<span class="token punctuation">.</span>user<span class="token punctuation">)</span>

	<span class="token keyword">def</span> <span class="token function">test_view</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
	    <span class="token comment">#лучше использовать response.data, а не json.loads(response.content)</span>
	    data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'id'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'username'</span><span class="token punctuation">:</span> <span class="token string">'lauren'</span><span class="token punctuation">}</span>
		response <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'/users/4/'</span><span class="token punctuation">)</span>
		self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">,</span> data<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">test_create_account</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Ensure we can create a new account object.
        """</span>
        url <span class="token operator">=</span> reverse<span class="token punctuation">(</span><span class="token string">'account-list'</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'DabApps'</span><span class="token punctuation">}</span>
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'json'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> status<span class="token punctuation">.</span>HTTP_201_CREATED<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>Account<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>Account<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">'DabApps'</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="фабричный-метод-и-фабрики">Фабричный метод и фабрики</h2>
<p>Фабричный метод (Factory Method) - порождающий паттерн проектирования, который определяет интерфейс для создания объектов некоторого класса, но непосредственное решение о том, объект какого класса создавать происходит в подклассах. То есть паттерн предполагает, что базовый класс делегирует создание объектов классам-наследникам.</p>
<h3 id="requestfactory-фабрика-запросов">RequestFactory (<a href="https://djangodoc.ru/3.1/topics/testing/advanced/#the-request-factory">Фабрика запросов)</a></h3>
<p>Класс RequestFactory использует тот же API, что и тестовый клиент. Однако вместо того, чтобы вести себя как браузер, RequestFactory предлагает способ создания экземпляра запроса, который может использоваться в качестве первого параметра любого представления. Это позволяет тестировать функцию просмотра так же, как вы тестируете любую другую функцию, например черный ящик, с известными данными в качестве входных данных и тестированием определенного результата.</p>
<p>API RequestFactory немного более ограничен, чем у тестового клиента:</p>
<p>Это дает доступ к методам HTTP только <code>get() , post() , put() , delete() , head() , options() и trace()</code>.<br>
Все эти методы принимают одни и те же параметры. Поскольку это только фабрика, производящая запросы, вы несете ответственность за ответ.<br>
Он не поддерживает промежуточное ПО. Атрибуты сеанса и аутентификации должны быть предоставлены самим тестом, если необходимо, для правильной работы представления.<br>
Для чего необходим RequestFactory? Не для всех проверок нужно делать запрос, часто необходимо его только имитировать.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>test <span class="token keyword">import</span> RequestFactory<span class="token punctuation">,</span> TestCase

<span class="token keyword">from</span> <span class="token punctuation">.</span>views <span class="token keyword">import</span> MyView<span class="token punctuation">,</span> my_view

<span class="token keyword">class</span> <span class="token class-name">SimpleTest</span><span class="token punctuation">(</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">setUp</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Every test needs access to the request factory.</span>
        self<span class="token punctuation">.</span>factory <span class="token operator">=</span> RequestFactory<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>user <span class="token operator">=</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create_user<span class="token punctuation">(</span>
            username<span class="token operator">=</span><span class="token string">'jacob'</span><span class="token punctuation">,</span> email<span class="token operator">=</span><span class="token string">'jacob@…'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'top_secret'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">test_details</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Create an instance of a GET request.</span>
        request <span class="token operator">=</span> self<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'/customer/details'</span><span class="token punctuation">)</span>

        <span class="token comment"># Recall that middleware are not supported. You can simulate a</span>
        <span class="token comment"># logged-in user by setting request.user manually.</span>
        request<span class="token punctuation">.</span>user <span class="token operator">=</span> self<span class="token punctuation">.</span>user

        <span class="token comment"># Or you can simulate an anonymous user by setting request.user to</span>
        <span class="token comment"># an AnonymousUser instance.</span>
        request<span class="token punctuation">.</span>user <span class="token operator">=</span> AnonymousUser<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># Test my_view() as if it were deployed at /customer/details</span>
        response <span class="token operator">=</span> my_view<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        <span class="token comment"># Use this syntax for class-based views.</span>
        response <span class="token operator">=</span> MyView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="factory-boy"><a href="https://factoryboy.readthedocs.io/en/stable/index.html">Factory Boy</a></h3>
<pre class=" language-python"><code class="prism  language-python">pip install factory_boy
</code></pre>
<p>Прописывание в <code>setUp</code> создание новых обектов может занимать очень много времени. Что-бы это ускорить, упростить и автоматизировать, можно написать свою фабрику</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> factory
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> base

<span class="token keyword">class</span> <span class="token class-name">UserFactory</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>Factory<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> base<span class="token punctuation">.</span>User

    firstname <span class="token operator">=</span> <span class="token string">"John"</span>
    lastname <span class="token operator">=</span> <span class="token string">"Doe"</span>
</code></pre>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>john <span class="token operator">=</span> UserFactory<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>User<span class="token punctuation">:</span> John Doe<span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>jack <span class="token operator">=</span> UserFactory<span class="token punctuation">(</span>firstname<span class="token operator">=</span><span class="token string">"Jack"</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>User<span class="token punctuation">:</span> Jack Doe<span class="token operator">&gt;</span>
</code></pre>
<p>На один класс можно создавать несколько фабрик</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">EnglishUserFactory</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>Factory<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> base<span class="token punctuation">.</span>User

    firstname <span class="token operator">=</span> <span class="token string">"John"</span>
    lastname <span class="token operator">=</span> <span class="token string">"Doe"</span>
    lang <span class="token operator">=</span> <span class="token string">'en'</span>

<span class="token keyword">class</span> <span class="token class-name">FrenchUserFactory</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>Factory<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> base<span class="token punctuation">.</span>User

    firstname <span class="token operator">=</span> <span class="token string">"Jean"</span>
    lastname <span class="token operator">=</span> <span class="token string">"Dupont"</span>
    lang <span class="token operator">=</span> <span class="token string">'fr'</span>
</code></pre>
<pre class=" language-python"><code class="prism  language-python">EnglishUserFactory<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>User<span class="token punctuation">:</span> John Doe <span class="token punctuation">(</span>en<span class="token punctuation">)</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> FrenchUserFactory<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>User<span class="token punctuation">:</span> Jean Dupont <span class="token punctuation">(</span>fr<span class="token punctuation">)</span><span class="token operator">&gt;</span>
</code></pre>
<h3 id="sequences">Sequences</h3>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">UserFactory</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>Factory<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> models<span class="token punctuation">.</span>User

    username <span class="token operator">=</span> factory<span class="token punctuation">.</span>Sequence<span class="token punctuation">(</span><span class="token keyword">lambda</span> n<span class="token punctuation">:</span> <span class="token string">'user%d'</span> <span class="token operator">%</span> n<span class="token punctuation">)</span>
</code></pre>
<h3 id="lazyfunction">LazyFunction</h3>
<p>При создании можно использовать функции,которые не зависят то класса</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">LogFactory</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>Factory<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> models<span class="token punctuation">.</span>Log

    timestamp <span class="token operator">=</span> factory<span class="token punctuation">.</span>LazyFunction<span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">)</span>
</code></pre>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> LogFactory<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>Log<span class="token punctuation">:</span> log at <span class="token number">2016</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">17</span><span class="token punctuation">:</span><span class="token number">02</span><span class="token punctuation">:</span><span class="token number">34</span><span class="token operator">&gt;</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token comment"># The LazyFunction can be overridden</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> LogFactory<span class="token punctuation">(</span>timestamp<span class="token operator">=</span>now <span class="token operator">-</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>Log<span class="token punctuation">:</span> log at <span class="token number">2016</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">11</span> <span class="token number">17</span><span class="token punctuation">:</span><span class="token number">02</span><span class="token punctuation">:</span><span class="token number">34</span><span class="token operator">&gt;</span>
</code></pre>
<h3 id="lazyattribute">LazyAttribute</h3>
<p>Некоторые поля могут быть заполнены при помощи других, например электронная почта на основе имени пользователя. LazyAttribute обрабатывает такие случаи: он должен получить функцию, принимающую создаваемый объект и возвращающую значение для поля:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">UserFactory</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>Factory<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> models<span class="token punctuation">.</span>User

    username <span class="token operator">=</span> factory<span class="token punctuation">.</span>Sequence<span class="token punctuation">(</span><span class="token keyword">lambda</span> n<span class="token punctuation">:</span> <span class="token string">'user%d'</span> <span class="token operator">%</span> n<span class="token punctuation">)</span>
    email <span class="token operator">=</span> factory<span class="token punctuation">.</span>LazyAttribute<span class="token punctuation">(</span><span class="token keyword">lambda</span> obj<span class="token punctuation">:</span> <span class="token string">'%s@example.com'</span> <span class="token operator">%</span> obj<span class="token punctuation">.</span>username<span class="token punctuation">)</span>
</code></pre>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>UserFactory<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>User<span class="token punctuation">:</span> user1 <span class="token punctuation">(</span>user1@example<span class="token punctuation">.</span>com<span class="token punctuation">)</span><span class="token operator">&gt;</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token comment"># The LazyAttribute handles overridden fields</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> UserFactory<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'john'</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>User<span class="token punctuation">:</span> john <span class="token punctuation">(</span>john@example<span class="token punctuation">.</span>com<span class="token punctuation">)</span><span class="token operator">&gt;</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token comment"># They can be directly overridden as well</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> UserFactory<span class="token punctuation">(</span>email<span class="token operator">=</span><span class="token string">'doe@example.com'</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>User<span class="token punctuation">:</span> user3 <span class="token punctuation">(</span>doe@example<span class="token punctuation">.</span>com<span class="token punctuation">)</span><span class="token operator">&gt;</span>
</code></pre>
<h3 id="наследование">Наследование</h3>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">UserFactory</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>Factory<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> base<span class="token punctuation">.</span>User

    firstname <span class="token operator">=</span> <span class="token string">"John"</span>
    lastname <span class="token operator">=</span> <span class="token string">"Doe"</span>
    group <span class="token operator">=</span> <span class="token string">'users'</span>

<span class="token keyword">class</span> <span class="token class-name">AdminFactory</span><span class="token punctuation">(</span>UserFactory<span class="token punctuation">)</span><span class="token punctuation">:</span>
    admin <span class="token operator">=</span> <span class="token boolean">True</span>
    group <span class="token operator">=</span> <span class="token string">'admins'</span>
</code></pre>
<h3 id="fuzzy-attributes"><a href="https://factoryboy.readthedocs.io/en/stable/fuzzy.html">Fuzzy attributes</a></h3>
<p>Fuzzy позволяет генерировать фейковые данные</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> factory <span class="token keyword">import</span> fuzzy
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">def</span> <span class="token function">setUp</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    self<span class="token punctuation">.</span>username <span class="token operator">=</span> fuzzy<span class="token punctuation">.</span>FuzzyText<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fuzz<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    self<span class="token punctuation">.</span>password <span class="token operator">=</span> fuzzy<span class="token punctuation">.</span>FuzzyText<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fuzz<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    self<span class="token punctuation">.</span>user_id <span class="token operator">=</span> fuzzy<span class="token punctuation">.</span>FuzzyInteger<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fuzz<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="faker"><a href="https://faker.readthedocs.io/en/master/">Faker</a></h3>
<p>Faker пришел на звамену Fuzzy</p>
<pre class=" language-python"><code class="prism  language-python">pip install Faker
</code></pre>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> faker <span class="token keyword">import</span> Faker
fake <span class="token operator">=</span> Faker<span class="token punctuation">(</span><span class="token punctuation">)</span>

fake<span class="token punctuation">.</span>name<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 'Lucy Cechtelar'</span>

fake<span class="token punctuation">.</span>address<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># '426 Jordy Lodge</span>
<span class="token comment">#  Cartwrightshire, SC 88120-6700'</span>

fake<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 'Sint velit eveniet. Rerum atque repellat voluptatem quia rerum. Numquam excepturi</span>
<span class="token comment">#  beatae sint laudantium consequatur. Magni occaecati itaque sint et sit tempore. Nesciunt</span>
<span class="token comment">#  amet quidem. Iusto deleniti cum autem ad quia aperiam.</span>
<span class="token comment">#  A consectetur quos aliquam. In iste aliquid et aut similique suscipit. Consequatur qui</span>
<span class="token comment">#  quaerat iste minus hic expedita. Consequuntur error magni et laboriosam. Aut aspernatur</span>
<span class="token comment">#  voluptatem sit aliquam. Dolores voluptatum est.</span>
<span class="token comment">#  Aut molestias et maxime. Fugit autem facilis quos vero. Eius quibusdam possimus est.</span>
<span class="token comment">#  Ea quaerat et quisquam. Deleniti sunt quam. Adipisci consequatur id in occaecati.</span>
<span class="token comment">#  Et sint et. Ut ducimus quod nemo ab voluptatum.'</span>
</code></pre>
<p>Использование с  Factory Boy</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> factory
<span class="token keyword">from</span> myapp<span class="token punctuation">.</span>models <span class="token keyword">import</span> Book

<span class="token keyword">class</span> <span class="token class-name">BookFactory</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span>Factory<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> Book

    title <span class="token operator">=</span> factory<span class="token punctuation">.</span>Faker<span class="token punctuation">(</span><span class="token string">'sentence'</span><span class="token punctuation">,</span> nb_words<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
    author_name <span class="token operator">=</span> factory<span class="token punctuation">.</span>Faker<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>
</code></pre>
<p><strong><a href="https://faker.readthedocs.io/en/master/providers.html">Providers</a></strong><br>
У Faker есть большое количество шаблонов, которые расположены в так называемых провайдерах</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> faker <span class="token keyword">import</span> Faker
<span class="token keyword">from</span> faker<span class="token punctuation">.</span>providers <span class="token keyword">import</span> internet

fake <span class="token operator">=</span> Faker<span class="token punctuation">(</span><span class="token punctuation">)</span>
fake<span class="token punctuation">.</span>add_provider<span class="token punctuation">(</span>internet<span class="token punctuation">)</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> fake<span class="token punctuation">.</span>ipv4_private<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token string">'10.10.11.69'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> fake<span class="token punctuation">.</span>ipv4_private<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token string">'10.86.161.98'</span>
</code></pre>
<h2 id="итоги">Итоги</h2>
<p>Написание тестов не является ни весельем, ни развлечением и, соответственно, при создании сайтов часто остается напоследок (или вообще не используется). Но тем не менее, они являются действенным механизмом, который позволяет вам убедиться, что ваш код в находится безопасности, даже если в него добавляются какие-либо изменения. Кроме того, тесты повышают эффективность поддержки вашего кода.</p>
<h2 id="литература">Литература</h2>
<ol>
<li><a href="https://developer.mozilla.org/ru/docs/Learn/Server-side/Django/Testing">Тестирование приложений Django от mozilla</a></li>
<li><a href="https://github.com/mdn/django-locallibrary-tutorial">Web-приложение с примерами тестов</a></li>
</ol>

