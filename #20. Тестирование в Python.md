---


---

<h1 id="тестирование-в-python">Тестирование в Python</h1>
<p><img src="https://files.realpython.com/media/Getting-Started-with-Testing-in-Python_Watermarked.9f22be97343d.jpg" alt="enter image description here"></p>
<h2 id="план">План</h2>
<ol>
<li><a href="#intro-to-test">Введение в тестирование</a>
<ol>
<li>Что такое тестирование и баг</li>
<li>Распространенные причины появления ошибок</li>
<li>Виды тестирования</li>
<li>Кто должен тестировать?</li>
<li>Когда начинать тестировать?</li>
<li>TDD</li>
</ol>
</li>
<li><a href="#python-test">Тестирование в Python</a>
<ol>
<li>Assertion</li>
<li>unittest</li>
<li>pytest, tox, nose2, docktest</li>
<li>mock</li>
</ol>
</li>
<li><a href="#literature">Литература (Что почитать)</a></li>
</ol>
<h2 id="a-idintro-to-testaвведение-в-тестирование"><a id="intro-to-test"></a>Введение в тестирование</h2>
<p><strong>Тестирование программного обеспечения</strong>  -  процесс исследования, испытания программного продукта, имеющий своей целью проверку соответствия между реальным поведением программы и её ожидаемым поведением.</p>
<p>Тестирование - сравнение фактического результата с ожидаемым</p>
<center><strong>Actual Result == Expected Result</strong></center>
<p><strong>Цели тестирования</strong></p>
<ul>
<li>Повысить вероятность того, что приложение, предназначенное для<br>
тестирования, будет работать правильно при любых обстоятельствах.</li>
<li>Повысить вероятность того, что приложение, предназначенное для<br>
тестирования, будет соответствовать всем описанным требованиям.</li>
<li>Предоставление актуальной информации о состоянии продукта на данный   момент.</li>
</ul>
<p><strong>Программная ошибка</strong> он же <strong>баг</strong></p>
<center><strong>Actual Result != Expected Result</strong></center>
<p><strong>Баг</strong> (bug)– это ошибка в программе, вызывающая ее неправильную и (или) непредсказуемую работу, также багом называют отличие между фактическим и ожидаемым результатом. Из-за дефектов, допущенных еще во время написания кода, программа может не выполнять заложенных функций, работать не так, как обозначено в спецификации, или выполнять действия, которые не предусмотрены. Такие случаи называются сбоями программы (failure).</p>
<p><strong>Распространенные причины появления ошибок</strong>(<a href="https://training.qatestlab.com/blog/technical-articles/causes-of-defects-and-failures/">подробнее тут</a>):</p>
<ol>
<li>Проблемы в коммуникациях между членами команды</li>
<li>Изменение требований</li>
<li>Временные рамки</li>
<li>Ошибки программистов
<ul>
<li>опечатки и невнимательность;</li>
<li>непонимание логики участка кода;</li>
<li>незнание тонкостей языка разработки;</li>
<li>ложные тесты;</li>
<li>отсутствие обработки ошибок;</li>
<li>копирование чужих ошибок</li>
</ul>
</li>
<li>Баги в инструментах для разработки программного обеспечения</li>
<li>Аппаратные проблемы(битая память, <a href="https://habr.com/ru/post/332552/">баг в процессорах Intel Skylake</a>)</li>
<li>Ошибки тестировщиков</li>
<li>Некачественный контроль версий кода</li>
<li>Архитектура программного обеспечения</li>
<li>Недостаток финансирования</li>
</ol>
<p><img src="https://drive.google.com/uc?export=view&amp;id=1xsKUWARAIdtTEJ9psYz6SRCZLi40oEd7" alt="enter image description here"></p>
<p><strong>Последствия</strong></p>
<ol>
<li>Ошибки в программном обеспечении медицинского аппарата лучевой терапии <a href="https://habr.com/ru/company/pvs-studio/blog/307788/">Therac-25</a> привели к превышению доз облучения нескольких людей. С июня 1985 года по январь 1987 года этот аппарат стал причиной шести передозировок радиации, некоторые пациенты получили дозы в десятки тысяч рад. Как минимум двое умерли непосредственно от передозировок</li>
<li>Ракета Ariane 5: ущерб в 8,5 млрд долларов<br>
4 июня 1996 года случился неудачный запуск ракеты-носителя Ariane 5, которая была разработана Европейским космическим агентством. Ракета разрушилась на 39-й секунде полета из-за неверной работы бортового программного обеспечения. Эта история запомнилась, как одна из самых дорогостоящих компьютерных ошибок.</li>
<li>Финансовая организация Knight Capital Group  потеряла 440 миллионов долларов за 45 минут из-за ошибки в программе высокочастотного трейдинга.</li>
</ol>
<p><a href="https://xakep.ru/2005/11/14/28735/">Худшие компьютерные баги в истории</a><br>
<a href="https://habr.com/ru/post/307394/">Самые дорогие и судьбоносные ошибки в ИТ-индустрии</a></p>
<p><strong>Виды тестирования</strong></p>
<p><em>Функциональное тестирование</em> — это тестирование ПО в целях проверки реализуемости функциональных требований, то есть способности ПО в определённых условиях решать задачи, нужные пользователям. Функциональные требования определяют, что именно делает ПО, какие задачи оно решает.</p>
<p>Функциональные требования включают в себя:</p>
<ul>
<li>Функциональная пригодность (англ. suitability).</li>
<li>Точность (англ. accuracy).</li>
<li>Способность к взаимодействию (англ. interoperability).</li>
<li>Соответствие стандартам и правилам (англ. compliance).</li>
<li>Защищённость (англ. security).</li>
</ul>
<p><em>Не функциональное тестирование ПО</em> — в первую очередь проверка на соответствие не функциональным требованиям:</p>
<ul>
<li>Удобство (В основном производиться оценка удобства для пользователей)</li>
<li>Маштабируемость (проверяется как вертикальная так и горизонтальная маштабируемость тестируемого приложения)</li>
<li>Производительность (Способность работы приложения при различных нагрузках)</li>
<li>Безопасность (Защита пользовательских данных, защита данных приложения, стойкость на взлом)</li>
<li>Портируемость (Совместимость и переносимость приложения для и под различные окружения, платформы и т.д.)</li>
<li>Надежность (Поведение системы при различных непредвиденных ситуациях, способность обработки нестандартных действий пользователя)</li>
</ul>
<p>И еще немного видов тестирования</p>
<p><img src="https://drive.google.com/uc?export=view&amp;id=19CJ6xqys-0xApy2rnfaSN1OFZCtBL3Fg" alt="test_table"><br>
<a href="https://habr.com/ru/post/279535/">Тестирование. Фундаментальная теория</a></p>
<p><strong>Кто должен тестировать?</strong> (все, кто может)<br>
<img src="https://drive.google.com/uc?export=view&amp;id=1V0Rg3UacdkqXR_pp_jRYzu02n3rvNSXz" alt="test_table"></p>
<p>Хороший программист никогда не должен передавать программу в отдел тестирования без первой обработки тестовых сценариев, которая определяет, отвечает ли программа определенным требованиям.<br>
У тестировщиков и программистов есть различные цели, когда они тестируют программное обеспечение.</p>
<ul>
<li>Тестировщик - это тот, кто пишет и/или выполняет тестирование программного обеспечения с намерением продемонстрировать, что программа не работает.</li>
<li>Программист – это тот, чьи тестирования предназначены, чтобы показать, что программа действительно работает.<br>
(Борис Бейзер  «Software Testing Techniques»)</li>
</ul>
<p><strong>Когда начинать тестировать?</strong><br>
Чем раньше в жизненном цикле программы начнется тестирование, тем в большей степени мы можем быть уверены в ее качестве.<br>
<img src="https://drive.google.com/uc?export=view&amp;id=1hPDwtk2LeI9dEqEdR-CnTKPAuaZzQzDq" alt="test_table"></p>
<p><strong>TDD</strong> (test-driven development)<br>
Разработка через тестирование — техника разработки программного обеспечения, которая основывается на повторении очень коротких циклов разработки: сначала пишется тест, покрывающий желаемое изменение, затем пишется код, который позволит пройти тест, и под конец проводится рефакторинг нового кода к соответствующим стандартам.<br>
<img src="https://www.pvsm.ru/images/vvedenie-v-TDD-%C2%ABna-palcah%C2%BB-(Rails--Rspec).gif" alt="Картинки по запросу &quot;tdd&quot;"></p>
<h2 id="a-idpython-testa-тестирование-в-python"><a id="python-test"></a> Тестирование в Python</h2>
<p><strong>Что такое Assertion</strong><br>
Assertions (утверждения) — это инструкции, которые «утверждают» определенный кейс в программе. В Python они выступают булевыми выражениями, которые проверяют, является ли условие истинным или ложным.<br>
Для проверки используется  оператор assert</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">assert</span> condition
</code></pre>
<p>Если выражение истинно, то программа ничего не делает и переходит к выполнению следующей строчки кода.<br>
Но если оно ложно, то программа останавливается и возвращает ошибку.</p>
<p>Если же нужно добавить сообщение для вывода при ложном условии, то синтаксис будет таким.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">assert</span> condition<span class="token punctuation">,</span> message
</code></pre>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> b <span class="token operator">=</span> <span class="token number">2</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">assert</span>  a <span class="token operator">!=</span> b
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">assert</span>  a <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span> <span class="token operator">and</span> b <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'a and b can not be empty'</span>

Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"&lt;stdin&gt;"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">&gt;</span>
AssertionError<span class="token punctuation">:</span> a <span class="token operator">and</span> can <span class="token operator">not</span> be empty
</code></pre>
<p>assert может использоваться прямо в коде, а не в тесте, для предотвращения базовых ошибок, например, передача None в важном аргументе. Не подходит для серьезных проектов, но на этапе прототипирования может очень сэкономить время разработки.</p>
<p><strong>Инструменты для тестирование</strong></p>
<ul>
<li>unittest</li>
<li>pytest</li>
<li>doctest</li>
<li>tox</li>
<li>nose</li>
</ul>
<h3 id="unittest"><a href="https://docs.python.org/3/library/unittest.html">unittest</a></h3>
<p>unittest - это framework для тестирования, входящий в стандартную библиотеку языка Python. Его архитектура выполнена в стиле xUnit. xUnit представляет собой семейство framework’ов для тестирования в разных языках программирования, в Java – это JUnit (а Unittest это порт JUnit), C# – NUnit и т.д.</p>
<p>В использовании unittest присутствуют несколько концепций:</p>
<ul>
<li>
<p><em>test case</em> -это наименьшая единица тестирования. Он проверяет конкретный ответ для конкретного набора входных данных.Для реализации этой сущности используется класс TestCase</p>
</li>
<li>
<p><em>test suite</em> - это коллекция тестов, которая может в себя включать как отдельные test case’ы так и целые коллекции (т.е. можно создавать коллекции коллекций). Коллекции используются с целью объединения тестов для совместного запуска.</p>
</li>
<li>
<p><em>test runner</em> - это компонент, который организует выполнение тестов и предоставляет результат пользователю.Test runner может иметь графический интерфейс, текстовый интерфейс или возвращать какое-то заранее заданное значение, которое будет описывать результат прохождения тестов.</p>
</li>
<li>
<p><em>test fixture</em> - это фиксированное состояние объектов используемых в качестве исходного при выполнении тестов.</p>
</li>
</ul>
<p>Цель использования fixture - если у вас сложный test case, то подготовка нужного состояния легко может занимать много ресурсов (например, вы считаете функцию с определенной точностью и каждый следующий знак точности в расчетах занимает день). Используя fixture (на сленге - фикстуры) предварительную подготовку состояния пропускаем и сразу приступаем к тестированию.</p>
<p>Test fixture может выступать, например, в виде:<br>
–   состояние базы данных<br>
–   набор переменных среды<br>
–   набор файлов с необходимым содержанием.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> unittest

<span class="token keyword">class</span> <span class="token class-name">StringMethodTest</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">test_isupper</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>assertTrue<span class="token punctuation">(</span><span class="token string">'FOO'</span><span class="token punctuation">.</span>isupper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertFalse<span class="token punctuation">(</span><span class="token string">'Foo'</span><span class="token punctuation">.</span>isupper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">test_split</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        s <span class="token operator">=</span> <span class="token string">'hello world'</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>s<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'hello'</span><span class="token punctuation">,</span> <span class="token string">'world'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
<p>Для того, чтобы метод класса выполнялся как тест, необходимо, чтобы он начинался со слова <em>test</em>. Несмотря на то, что методы <em>framework’а unittest</em> написаны не в соответствии с <em>PEP 8</em> (ввиду того, что идейно он наследник <em>xUnit</em>), необходимо следовать правилам стиля для Python везде, где это возможно. Поэтому имена тестов будем начинать с префикса <em>test</em>_.</p>
<p><strong>Методы, используемые при запуске тестов</strong></p>
<ul>
<li>
<p>setUp()<br>
Метод вызывается перед запуском теста. Как правило, используется для подготовки окружения для теста.</p>
</li>
<li>
<p>tearDown()<br>
Метод вызывается после завершения работы теста. Используется для закрытия файла, удаления данных, и т.д.</p>
</li>
</ul>
<p>Методы  <em>setUp()</em>  и  <em>tearDown()</em>  вызываются для всех тестов в рамках класса, в котором они переопределены. По умолчанию, эти методы ничего не делают.</p>
<p><img src="https://devpractice.ru/wp-content/uploads/2017/07/python-unittest-part2-3.png" alt="unittest TestCase setUp/tearDown work"></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> unittest

<span class="token keyword">class</span> <span class="token class-name">WidgetTest</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">setUp</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>widget <span class="token operator">=</span> Widget<span class="token punctuation">(</span><span class="token string">'The widget'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">test_default_widget_size</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>self<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         <span class="token string">'incorrect default size'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">test_widget_resize</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>self<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         <span class="token string">'wrong size after resize'</span><span class="token punctuation">)</span>
</code></pre>
<p><em>TestCase</em> класс предоставляет набор <em>assert</em>-методов для проверки и генерации ошибок:</p>
<table>
<tbody>
<tr>
<td><a href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertEqual"><span>assertEqual(a, b)</span></a></td>
<td><span>a == b</span></td>
</tr>
<tr>
<td><a href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertNotEqual"><span>assertNotEqual(a, b)</span></a></td>
<td><span>a != b</span></td>
</tr>
<tr>
<td><a href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertTrue"><span>assertTrue(x)</span></a></td>
<td><span>bool(x) is True</span></td>
</tr>
<tr>
<td><a href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertFalse"><span>assertFalse(x)</span></a></td>
<td><span>bool(x) is False</span></td>
</tr>
<tr>
<td><a href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertIs"><span>assertIs(a, b)</span></a></td>
<td><span>a is b</span></td>
</tr>
<tr>
<td><a href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertIsNot"><span>assertIsNot(a, b)</span></a></td>
<td><span>a is not b</span></td>
</tr>
<tr>
<td><a href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertIsNone"><span>assertIsNone(x)</span></a></td>
<td><span>x is None</span></td>
</tr>
<tr>
<td><a href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertIsNotNone"><span>assertIsNotNone(x)</span></a></td>
<td><span>x is not None</span></td>
</tr>
<tr>
<td><a href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertIn"><span>assertIn(a, b)</span></a></td>
<td><span>a in b</span></td>
</tr>
<tr>
<td><a href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertNotIn"><span>assertNotIn(a, b)</span></a></td>
<td><span>a not in b</span></td>
</tr>
<tr>
<td><a href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertIsInstance"><span>assertIsInstance(a, b)</span></a></td>
<td><span>isinstance(a, b)</span></td>
</tr>
<tr>
<td><a href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertNotIsInstance"><span>assertNotIsInstance(a, b)</span></a></td>
<td><span>not isinstance(a, b)</span></td>
</tr>
</tbody>
</table>
Это далеко не весь список, остальные методы описаны в документации.
<p><strong>Где Писать Тест</strong></p>
<p>Начать написание теста можно с создания файла <code>test.py</code>, в котором будет содержаться ваш первый тест-кейс. Для тестирования у файла должна быть возможность импортировать ваше приложение, поэтому положите <code>test.py</code> в папку над пакетом.<br>
По мере добавления новых тестов, ваш файл становится все более громоздким и сложным для поддержки, поэтому советуем создать папку <code>tests/</code> и разделить тесты на несколько файлов. Названия всех файлов должны начинаться с <code>test_</code>, чтобы исполнители тестов понимали, что файлы Python содержат тесты, которые нужно выполнить. На больших проектах тесты делят на несколько директорий в зависимости от их назначения или использования.</p>
<p><strong>Запуск тестов</strong></p>
<ol>
<li><em><strong>Command-Line Interface (CLI)</strong></em><br>
Что-бы найти и запустить все тесты , можно просто вызвать модуль unittest, при этом будет запущен Test Discovery для поиска.</li>
</ol>
<pre class=" language-python"><code class="prism  language-python">  python <span class="token operator">-</span>m unittest 
  
<span class="token punctuation">.</span><span class="token punctuation">.</span>F
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
FAIL<span class="token punctuation">:</span> test_split_2 <span class="token punctuation">(</span>test_view<span class="token punctuation">.</span>StringMethodTest<span class="token punctuation">)</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"/home/artem/PycharmProjects/pythonProject/test_view.py"</span><span class="token punctuation">,</span> line <span class="token number">15</span><span class="token punctuation">,</span> <span class="token keyword">in</span> test_split_2
    self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>s<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'hello'</span><span class="token punctuation">,</span> <span class="token string">'wodrld'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
AssertionError<span class="token punctuation">:</span> Lists differ<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'hello'</span><span class="token punctuation">,</span> <span class="token string">'world'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token punctuation">[</span><span class="token string">'hello'</span><span class="token punctuation">,</span> <span class="token string">'wodrld'</span><span class="token punctuation">]</span>

First differing element <span class="token number">1</span><span class="token punctuation">:</span>
<span class="token string">'world'</span>
<span class="token string">'wodrld'</span>

<span class="token operator">-</span> <span class="token punctuation">[</span><span class="token string">'hello'</span><span class="token punctuation">,</span> <span class="token string">'world'</span><span class="token punctuation">]</span>
<span class="token operator">+</span> <span class="token punctuation">[</span><span class="token string">'hello'</span><span class="token punctuation">,</span> <span class="token string">'wodrld'</span><span class="token punctuation">]</span>
?              <span class="token operator">+</span>


<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Ran <span class="token number">3</span> tests <span class="token keyword">in</span> <span class="token number">0.</span>001s

FAILED <span class="token punctuation">(</span>failures<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre>
<p>В качестве параметров можно указать имя директории, файла, класса или даже конкретой функции.</p>
<pre><code>   python -m unittest tests
   python -m unittest test_something.py
   python -m unittest test_module1 test_module2
   python -m unittest test_module.TestClass
   python -m unittest test_module.TestClass.test_method
</code></pre>
<ol start="2">
<li><em><strong>Graphical User Interface (GUI)</strong></em><br>
В PyCharm есть удобный способ запуска тестов:<br>
<img src="https://drive.google.com/uc?export=view&amp;id=197ly-AQrrIenrk6t6Iz1OLIXx2o59DTj" alt="enter image description here"></li>
</ol>
<p><img src="https://drive.google.com/uc?export=view&amp;id=1fMsNnb3_Mf_OmVz27HdLC55QNLnjB4Ez" alt="enter image description here"></p>
<p><strong>Пропуск тестов</strong><br>
Для пропуска тестов в unittest есть декораторы <code>skip</code> и <code>skipIf</code>, <code>skipUnless</code>.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">CalcBasicTests</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># Тест будет пропущен</span>
    @unittest<span class="token punctuation">.</span>skip<span class="token punctuation">(</span><span class="token string">"Temporaly skip test_add"</span><span class="token punctuation">)</span>    
    <span class="token keyword">def</span> <span class="token function">test_add</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>calc<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    
    <span class="token comment">#  Тест будет пропущен, если условие (condition) истинно  </span>
    @unittest<span class="token punctuation">.</span>skipIf<span class="token punctuation">(</span>condition<span class="token punctuation">,</span> reason<span class="token punctuation">)</span>   
    <span class="token keyword">def</span> <span class="token function">test_sub</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>calc<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        
   <span class="token comment">#  Тест будет пропущен если, условие (condition) не истинно. </span>
   @unittest<span class="token punctuation">.</span>skipUnless<span class="token punctuation">(</span>condition<span class="token punctuation">,</span> reason<span class="token punctuation">)</span>     
    <span class="token keyword">def</span> <span class="token function">test_mul</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>calc<span class="token punctuation">.</span>mul<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
        
    <span class="token keyword">def</span> <span class="token function">test_div</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>calc<span class="token punctuation">.</span>div<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="pytest"><a href="https://docs.pytest.org/en/latest/">pytest</a></h3>
<pre><code>pip install pytest
</code></pre>
<p>pytest довольно мощный инструмент для тестирования, и многие разработчики<br>
оставляют свой выбор именно на нем. pytest по “духу” ближе к языку Python нежели<br>
unittest. Как было сказано выше, unittest в своей базе – xUnit, что накладывает<br>
определенные обязательства при разработке тестов (создание классов-наследников<br>
от unittest.TestCase, выполнение определенной процедуры запуска тестов и т.п.). При<br>
разработке на pytest ничего этого делать не нужно, вы просто пишете функции, которые<br>
должны начинаться с “test_” и используете assert’ы, встроенные в Python (unittest<br>
использует свои).pytest также поддерживает выполнение тест-кейсов unittest.<br>
Есть в нем и другие полезные функции:</p>
<ul>
<li>Поддержка встроенных выражений assert вместо использования специальных self.assert*() методов;</li>
<li>Поддержка фильтрации тест-кейсов;</li>
<li>Возможность повторного запуска с последнего проваленного теста;</li>
<li>Экосистема из сотен плагинов, расширяющих функциональность.</li>
</ul>
<p>Пример тест-кейса TestSum для pytest будет выглядеть следующим образом:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">def</span> <span class="token function">test_sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">assert</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">"Should be 6"</span>

<span class="token keyword">def</span> <span class="token function">test_sum_tuple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">assert</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">"Should be 6"</span>
</code></pre>
<h3 id="tox"><a href="https://tox.readthedocs.io/en/latest/">tox</a></h3>
<pre><code>pip install tox
</code></pre>
<p>tox — библиотека, автоматизирующая тестирование в нескольких виртуальных средах.<br>
Tox настраивается через файл конфигурации в каталоге проекта. В нем содержится следующее:</p>
<ul>
<li>Что установить</li>
<li>Какие версии Python использовать</li>
<li>Что сделать перед запуском тестов</li>
<li>Как запускать тесты</li>
<li>Что делать после запуска тестов</li>
</ul>
<p>Вместо того, чтобы изучать синтаксис настройки Tox, можно начать с запуска quickstart-приложения.</p>
<pre><code>tox-quickstart
</code></pre>
<p>Инструмент настройки Tox задаст вам вопросы и создаст файл, похожий на следующий, в <code>tox.ini</code>:</p>
<pre><code>[tox]
envlist = py27, py36

[testenv]
deps = requests
commands = python -m unittest
</code></pre>
<p>Запуск tox из командной строки:</p>
<pre><code>tox
</code></pre>
<p>Tox выдаст результаты тестов для каждого окружения. При первом запуске Tox нужно время на создание виртуальных окружений, но при втором запуске все будет работать гораздо быстрее.<br>
Результаты работы Tox довольно простые. Создаются окружения для каждой версии, устанавливаются зависимости, а затем запускаются тестовые команды.</p>
<h3 id="nose-2"><a href="https://docs.nose2.io/en/latest/">nose 2</a></h3>
<pre><code>pip install nose2
</code></pre>
<p>Цель nose2 - расширить unittest, чтобы сделать тестирование более приятным и понятным. Со временем, после написания сотни, а то и тысячи тестов для приложения, становится все сложнее понимать и использовать данные вывода unittest.</p>
<p>Nose совместим со всеми тестами, написанными с unittest фреймворком, и может заменить его тестовый исполнитель. Разработка nose, как приложения с открытым исходным кодом, стала тормозиться, и был создан nose2. Если вы начинаете с нуля, рекомендуется использовать именно nose2.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># in test_fancy.py</span>
<span class="token keyword">from</span> nose2<span class="token punctuation">.</span>tools <span class="token keyword">import</span> params

@params<span class="token punctuation">(</span><span class="token string">"Sir Bedevere"</span><span class="token punctuation">,</span> <span class="token string">"Miss Islington"</span><span class="token punctuation">,</span> <span class="token string">"Duck"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">test_is_knight</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">assert</span> value<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'Sir'</span><span class="token punctuation">)</span>
</code></pre>
<pre><code>nose2 -v --pretty-assert
test_fancy.test_is_knight:1
'Sir Bedevere' ... ok
test_fancy.test_is_knight:2
'Miss Islington' ... FAIL
test_fancy.test_is_knight:3
'Duck' ... FAIL

======================================================================
FAIL: test_fancy.test_is_knight:2
'Miss Islington'
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/mnt/ebs/home/sirosen/tmp/test_fancy.py", line 6, in test_is_knight
    assert value.startswith('Sir')
AssertionError

&gt;&gt;&gt; assert value.startswith('Sir')

values:
    value = 'Miss Islington'
    value.startswith = &lt;built-in method startswith of str object at 0x7f3c3172f430&gt;
======================================================================
FAIL: test_fancy.test_is_knight:3
'Duck'
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/mnt/ebs/home/sirosen/tmp/test_fancy.py", line 6, in test_is_knight
    assert value.startswith('Sir')
AssertionError

&gt;&gt;&gt; assert value.startswith('Sir')

values:
    value = 'Duck'
    value.startswith = &lt;built-in method startswith of str object at 0x7f3c3172d490&gt;
----------------------------------------------------------------------
Ran 3 tests in 0.001s

FAILED (failures=2)
</code></pre>
<h3 id="doctest"><a href="https://docs.python.org/3/library/doctest.html">doctest</a></h3>
<p>Модуль  doctest  ищет куски текста, которые выглядят как интерактивные сессии Python и затем выполняет эти сессии, чтобы проверить, что они работают точно так же, как показано. Есть несколько стандартных причин, чтобы использовать doctest:</p>
<ul>
<li>Для того, чтобы проверить актуальность строк документации, убедившись, что все интерактивные примеры работают именно так, как задокументировано.</li>
<li>Чтобы организовать регрессионное тестирование, проверяя, что интерактивные примеры из тестового файла или тестового объекта работают как ожидается.</li>
<li>Чтобы написать руководство для пакета, иллюстрированное примерами ввода-вывода. В зависимости от того, на что обращается внимание - на примеры или на пояснительный текст, это можно назвать либо “литературным тестированием”, либо “исполняемой документацией”.</li>
</ul>
<pre class=" language-python"><code class="prism  language-python"><span class="token triple-quoted-string string">"""
Это модуль-пример.

Этот модуль предоставляет одну функцию - factorial().  Например,

&gt;&gt;&gt; factorial(5)
120
"""</span>

<span class="token keyword">def</span> <span class="token function">factorial</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Возвращает факториал числа n, которое является числом &gt;= 0.

 Если резульатат умещается в int, возвращается int.
 Иначе возвращается long.

 &gt;&gt;&gt; [factorial(n) for n in range(6)]
 [1, 1, 2, 6, 24, 120]
 &gt;&gt;&gt; [factorial(long(n)) for n in range(6)]
 [1, 1, 2, 6, 24, 120]
 &gt;&gt;&gt; factorial(30)
 265252859812191058636308480000000L
 &gt;&gt;&gt; factorial(30L)
 265252859812191058636308480000000L
 &gt;&gt;&gt; factorial(-1)
 Traceback (most recent call last):
 ...
 ValueError: n must be &gt;= 0

 Можно вычислять факториал числа с десятичной частью, если она
 равна 0:
 &gt;&gt;&gt; factorial(30.1)
 Traceback (most recent call last):
 ...
 ValueError: n must be exact integer
 &gt;&gt;&gt; factorial(30.0)
 265252859812191058636308480000000L

 Кроме того, число не должно быть слишком большим:
 &gt;&gt;&gt; factorial(1e100)
 Traceback (most recent call last):
 ...
 OverflowError: n too large
 """</span>

    <span class="token keyword">import</span> math
    <span class="token keyword">if</span> <span class="token operator">not</span> n <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"n must be &gt;= 0"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> math<span class="token punctuation">.</span>floor<span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">!=</span> n<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"n must be exact integer"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> n<span class="token operator">+</span><span class="token number">1</span> <span class="token operator">==</span> n<span class="token punctuation">:</span>  <span class="token comment"># перехватываем значения типа 1e300</span>
        <span class="token keyword">raise</span> OverflowError<span class="token punctuation">(</span><span class="token string">"n too large"</span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token number">1</span>
    factor <span class="token operator">=</span> <span class="token number">2</span>
    <span class="token keyword">while</span> factor <span class="token operator">&lt;=</span> n<span class="token punctuation">:</span>
        result <span class="token operator">*=</span> factor
        factor <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">return</span> result

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> doctest
    doctest<span class="token punctuation">.</span>testmod<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Если запустить <code>example.py</code> прямо из командной строки, то, doctest выполнит своё волшебство:</p>
<pre><code>python example.py
</code></pre>
<p>Тут нет никакого вывода. Это нормально и это означает, что все примеры работают. Если передать <code>-v</code> скрипту , то doctest выведет детальный лог того, что он делает и подведёт итог в конце:</p>
<pre><code>python example.py -v
Trying:
    factorial(5)
Expecting:
    120
ok
Trying:
    [factorial(n) for n in range(6)]
Expecting:
    [1, 1, 2, 6, 24, 120]
ok
Trying:
    [factorial(long(n)) for n in range(6)]
Expecting:
    [1, 1, 2, 6, 24, 120]
ok
</code></pre>
<p>И так далее, вплоть до:</p>
<pre><code>    factorial(1e100)
Expecting:
    Traceback (most recent call last):
        ...
    OverflowError: n too large
ok
2 items passed all tests:
   1 tests in __main__
   8 tests in __main__.factorial
9 tests in 2 items.
9 passed and 0 failed.
Test passed.
$
</code></pre>
<h3 id="mock"><a href="https://docs.python.org/3/library/unittest.mock.html">mock</a></h3>
<p>Mock на английском значит «имитация», «подделка». Модуль с таким названием помогает сильно упростить тесты модулей на Python.</p>
<p>Принцип его работы простой: если нужно тестировать функцию, то всё, что не относится к ней самой (например, чтение с диска или из сети), можно подменить макетами-пустышками. При этом тестируемые функции не нужно адаптировать для тестов: mock подменяет объекты в других модулях, даже если код не принимает их в виде параметров. То есть, тестировать можно вообще без адаптации под тесты.<br>
<img src="https://habrastorage.org/webt/fd/1p/zg/fd1pzggewxugrrc_va2z31wz5ni.jpeg" alt=""></p>
<p><img src="https://habrastorage.org/webt/rx/0w/b7/rx0wb7lgzqnkudkbufkxd7mtfng.jpeg" alt=""></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> unittest<span class="token punctuation">.</span>mock <span class="token keyword">import</span> Mock
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> mock <span class="token operator">=</span> Mock<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> mock
<span class="token operator">&lt;</span>Mock <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'140395983149664'</span><span class="token operator">&gt;</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> mock<span class="token punctuation">.</span>some_attribute
<span class="token operator">&lt;</span>Mock name<span class="token operator">=</span><span class="token string">'mock.some_attribute'</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'4394778696'</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> mock<span class="token punctuation">.</span>do_something<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>Mock name<span class="token operator">=</span><span class="token string">'mock.do_something()'</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'4394778920'</span><span class="token operator">&gt;</span>
</code></pre>
<p><strong>Какие преимущества имеет mock?</strong></p>
<ul>
<li>
<p><em>Высокая скорость</em><br>
Быстрые тесты бывают очень полезны. Например, если у вас есть ресурсоемкая функция, mock для этой функции сократит ненужное использование ресурсов во время тестирования, тем самым сократив время выполнения теста.</p>
</li>
<li>
<p><em>Избежание нежелательных побочных эффектов во время тестирования</em><br>
Если вы тестируете функцию, которая вызывает внешний API, скорее всего вам не особо хочется каждый раз вызывать API для того, чтобы запустить тест. Вам придется менять код каждый раз, когда изменяется API, или могут быть некоторые ограничения скорости, но mock помогает этого избежать.</p>
</li>
</ul>
<p><strong>Цепочки атрибутов:</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> m <span class="token operator">=</span> Mock<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> m
<span class="token operator">&lt;</span>Mock <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'167387660'</span><span class="token operator">&gt;</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> m<span class="token punctuation">.</span>any_attribute
<span class="token operator">&lt;</span>Mock name<span class="token operator">=</span><span class="token string">'mock.any_attribute'</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'167387436'</span><span class="token operator">&gt;</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> m<span class="token punctuation">.</span>any_attribute
<span class="token operator">&lt;</span>Mock name<span class="token operator">=</span><span class="token string">'mock.any_attribute'</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'167387436'</span><span class="token operator">&gt;</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> m<span class="token punctuation">.</span>another_attribute
<span class="token operator">&lt;</span>Mock name<span class="token operator">=</span><span class="token string">'mock.another_attribute'</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'167185324'</span><span class="token operator">&gt;&gt;</span>
</code></pre>
<p>Обращение к атрибуту выдаёт ещё один экземпляр класса Mock, а повторное обращение к тому же атрибуту — снова тот же экземпляр. Атрибут может быть чем угодно, в том числе и функцией. Наконец, любой макет можно вызвать (скажем, вместо класса):</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> m<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>Mock name<span class="token operator">=</span><span class="token string">'mock()'</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'167186284'</span><span class="token operator">&gt;</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> m<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">is</span> m
<span class="token boolean">False</span>
</code></pre>
<p>Это будет другой экземпляр, но если вызвать ещё раз, экземпляр будет тем же самым. Так мы можем назначить этим объектам некоторые свойства, после чего передать этот объект в тестируемый код, и они там будут считаны.</p>
<p>Если мы назначим атрибуту значение, то никаких сюрпризов: при следующем обращении получим именно это значение:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> m<span class="token punctuation">.</span>any_attribute
<span class="token operator">&lt;</span>Mock name<span class="token operator">=</span><span class="token string">'mock.any_attribute'</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'167387436'</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> m<span class="token punctuation">.</span>any_attribute <span class="token operator">=</span> <span class="token number">5</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> m<span class="token punctuation">.</span>any_attribute
<span class="token number">5</span>
</code></pre>
<p><strong>return_value и  side_effect</strong></p>
<p>Предположим вам нужно убедиться что ваш код в рабочие и в выходные дни ведёт себя по-разному, а код подразумевает использование строенной библиотеки <code>datetime</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime

<span class="token keyword">def</span> <span class="token function">is_weekday</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    today <span class="token operator">=</span> datetime<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># Python's datetime library treats Monday as 0 and Sunday as 6</span>
    <span class="token keyword">return</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> today<span class="token punctuation">.</span>weekday<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">5</span>

<span class="token comment"># Test if today is a weekday</span>
<span class="token keyword">assert</span> is_weekday<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Если запустить этот тест в воскресенье, то будет эксепшен, что же с этим делать? Замокать… Mock объект может возвращать по вызову любой функции необходимое нам значение, посредством заполнения <code>return_value</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> datetime
<span class="token keyword">from</span> unittest<span class="token punctuation">.</span>mock <span class="token keyword">import</span> Mock

<span class="token comment"># Save a couple of test days</span>
tuesday <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span>year<span class="token operator">=</span><span class="token number">2019</span><span class="token punctuation">,</span> month<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> day<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
saturday <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span>year<span class="token operator">=</span><span class="token number">2019</span><span class="token punctuation">,</span> month<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> day<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token comment"># Mock datetime to control today's date</span>
datetime <span class="token operator">=</span> Mock<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">is_weekday</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    today <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># Python's datetime library treats Monday as 0 and Sunday as 6</span>
    <span class="token keyword">return</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> today<span class="token punctuation">.</span>weekday<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">5</span>


<span class="token comment"># Mock .today() to return Tuesday</span>
datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>today<span class="token punctuation">.</span>return_value <span class="token operator">=</span> tuesday
<span class="token comment"># Test Tuesday is a weekday</span>
<span class="token keyword">assert</span> is_weekday<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># Mock .today() to return Saturday</span>
datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>today<span class="token punctuation">.</span>return_value <span class="token operator">=</span> saturday
<span class="token comment"># Test Saturday is not a weekday</span>
<span class="token keyword">assert</span> <span class="token operator">not</span> is_weekday<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Если необходимо, что бы после повторного вызова получить другие результаты то, в этом поможет <code>side_effect</code>,  которыйработает так же как и <code>return_value</code> только принимает перебираемый объект и с каждым вызовом возвращает следующее значение.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> mock_poll <span class="token operator">=</span> Mock<span class="token punctuation">(</span>side_effect<span class="token operator">=</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> mock_poll<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token boolean">None</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> mock_poll<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token string">'data'</span>
</code></pre>
<p>Или как на прошлом примере</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> datetime
<span class="token keyword">from</span> unittest<span class="token punctuation">.</span>mock <span class="token keyword">import</span> Mock

<span class="token comment"># Save a couple of test days</span>
tuesday <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span>year<span class="token operator">=</span><span class="token number">2019</span><span class="token punctuation">,</span> month<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> day<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
saturday <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span>year<span class="token operator">=</span><span class="token number">2019</span><span class="token punctuation">,</span> month<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> day<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token comment"># Mock datetime to control today's date</span>
datetime <span class="token operator">=</span> Mock<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">is_weekday</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    today <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># Python's datetime library treats Monday as 0 and Sunday as 6</span>
    <span class="token keyword">return</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> today<span class="token punctuation">.</span>weekday<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">5</span>


<span class="token comment"># Mock .today() to return Tuesday first time and Saturday second time</span>
datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>today<span class="token punctuation">.</span>side_effect <span class="token operator">=</span> <span class="token punctuation">[</span>tuesday<span class="token punctuation">,</span> saturday<span class="token punctuation">]</span>
<span class="token keyword">assert</span> is_weekday<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> <span class="token operator">not</span> is_weekday<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p><strong>Декоратор patch</strong><br>
Есть класс, который имитирует длительные вычисления:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> time

<span class="token keyword">class</span> <span class="token class-name">Calculator</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">sum</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment"># long running process</span>
        <span class="token keyword">return</span> a <span class="token operator">+</span> b
</code></pre>
<p>И тест к этой функции:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> unittest <span class="token keyword">import</span> TestCase
<span class="token keyword">from</span> main <span class="token keyword">import</span> Calculator


<span class="token keyword">class</span> <span class="token class-name">TestCalculator</span><span class="token punctuation">(</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">setUp</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>calc <span class="token operator">=</span> Calculator<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">test_sum</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        answer <span class="token operator">=</span> self<span class="token punctuation">.</span>calc<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>answer<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
</code></pre>
<p>Этот тест будет идти 10 секунд, имитирую длительный процесс, но можно симитировать выполнение этого метода.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> unittest <span class="token keyword">import</span> TestCase
<span class="token keyword">from</span> unittest<span class="token punctuation">.</span>mock <span class="token keyword">import</span> patch


<span class="token keyword">class</span> <span class="token class-name">TestCalculator</span><span class="token punctuation">(</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    @patch<span class="token punctuation">(</span><span class="token string">'main.Calculator.sum'</span><span class="token punctuation">,</span> return_value<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">test_sum</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">sum</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>
</code></pre>
<p>или</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> unittest <span class="token keyword">import</span> TestCase
<span class="token keyword">from</span> unittest<span class="token punctuation">.</span>mock <span class="token keyword">import</span> patch


<span class="token keyword">class</span> <span class="token class-name">TestCalculator</span><span class="token punctuation">(</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    @patch<span class="token punctuation">(</span><span class="token string">'main.Calculator.sum'</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">test_sum</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">sum</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">sum</span><span class="token punctuation">.</span>return_value <span class="token operator">=</span> <span class="token number">9</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>
</code></pre>
<p>Пропатченные методы попадают в аргументы метода теста.</p>
<p><strong>Более продвинутый пример использования</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> requests

<span class="token keyword">class</span> <span class="token class-name">Blog</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name

    <span class="token keyword">def</span> <span class="token function">posts</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://jsonplaceholder.typicode.com/posts"</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'&lt;Blog: {}&gt;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre>
<p>Этот код определяет класс Blog с методом posts. Запустив posts в Blog, произойдет инициирование вызова API. Ссылаясь на post в Blog, объект будет инициировать вызов API jsonplaceholder.</p>
<p>В данном тесте необходимо имитировать непредвиденный вызов API и проверить, что функция posts объекта Blog возвращает posts. Необходимо будет исправить все posts объекта Blog следующим образом.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> unittest <span class="token keyword">import</span> TestCase
<span class="token keyword">from</span> unittest<span class="token punctuation">.</span>mock <span class="token keyword">import</span> patch<span class="token punctuation">,</span> Mock


<span class="token keyword">class</span> <span class="token class-name">TestBlog</span><span class="token punctuation">(</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    @patch<span class="token punctuation">(</span><span class="token string">'main.Blog'</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">test_blog_posts</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> MockBlog<span class="token punctuation">)</span><span class="token punctuation">:</span>
        blog <span class="token operator">=</span> MockBlog<span class="token punctuation">(</span><span class="token punctuation">)</span>

        blog<span class="token punctuation">.</span>posts<span class="token punctuation">.</span>return_value <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token string">'userId'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token string">'id'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token string">'title'</span><span class="token punctuation">:</span> <span class="token string">'Test Title'</span><span class="token punctuation">,</span>
                <span class="token string">'body'</span><span class="token punctuation">:</span> <span class="token string">'Far out in the uncharted backwaters of the unfashionable end of the western spiral arm of the Galaxy\ lies a small unregarded yellow sun.'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>

        response <span class="token operator">=</span> blog<span class="token punctuation">.</span>posts<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertIsNotNone<span class="token punctuation">(</span>response<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertIsInstance<span class="token punctuation">(</span>response<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span>
</code></pre>
<p>Вы можете обратить внимание, что функция test_blog_posts украшена декоратором  @patch. Когда функция оформлена через @patch, mock класса, метода или функции, переданная в качестве цели для @patch, возвращается и передается в качестве аргумента декорируемой функции.</p>
<p>В этом случае @patch вызывается с помощью main.Blog и возвращает mock, который передается функции теста как MockBlog. Важно отметить, что цель, перешедшая к @patch, должна быть импортирована в @patch, из которой она была вызвана. В нашем случае импорт формы from main import Blog должен быть разрешен без каких либо проблем.</p>
<p>Кроме того, обратите внимание, что MockBlog является обычной переменной и вы можете назвать её, как хотите.</p>
<p>Вызов blog.posts() на нашем ложном объекте блога возвращает предопределенный JSON.<br>
Обратите внимание, что тестирование mock вместо фактического объекта блога, позволяет нам делать дополнительные утверждения о том, как mock использовался.</p>
<p>Например, mock позволяет проверить, сколько раз он вызывался, аргументы, с которыми он вызывался, и даже был ли mock вообще когда либо вызван.</p>
<h2 id="a-idliteratureaлитература-что-почитать"><a id="literature"></a>Литература (Что почитать)</h2>
<ol>
<li>Адаптированый перевод документации по unittest на <a href="https://devpractice.ru/python-unittest-lessons/">devpractice.ru</a></li>
<li><a href="https://realpython.com/python-mock-library/">Mock</a>,  и на <a href="https://nuancesprog.ru/p/1161/">русском</a></li>
<li>Знакомство с тестированием в Python на <a href="http://habr.com">habr.com</a>: <a href="https://habr.com/ru/company/otus/blog/433358/">1 часть</a>, <a href="https://habr.com/ru/company/otus/blog/433572/">2 часть</a>, <a href="https://habr.com/ru/company/otus/blog/444204/">3 часть</a></li>
<li>Введение в тестирование в Python на <a href="https://webdevblog.ru/vvedenie-v-testirovanie-v-python/">webdevblog.ru</a></li>
<li><a href="https://habr.com/ru/company/yandex/blog/517266/">Лекция от Яндекс</a></li>
</ol>

